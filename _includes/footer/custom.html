<style>
  .consent-banner{position:fixed;left:1rem;right:1rem;bottom:1rem;z-index:9999;max-width:46rem;margin:0 auto;padding:.85rem 1rem;background:#111;border:1px solid #333;border-radius:.5rem;box-shadow:0 6px 24px rgba(0,0,0,.35);color:#eee;font-size:.95rem;line-height:1.35}
  .consent-banner a{color:#9ecbff;text-decoration:underline}
  .consent-actions{display:flex;gap:.5rem;margin-top:.65rem;flex-wrap:wrap}
  .consent-btn{cursor:pointer;padding:.5rem .8rem;border-radius:.35rem;border:1px solid #444;background:#222;color:#eee}
  .consent-btn.primary{background:#2b6cb0;border-color:#2b6cb0}
  .consent-btn:hover{filter:brightness(1.1)}
  .consent-hidden{display:none!important}
</style>
<div id="consent-banner" class="consent-banner consent-hidden" role="dialog" aria-live="polite" aria-label="Privacy options">
  <div>
    We use Google Analytics (GA4) to measure site usage. We respect Do Not Track. You can accept or reject analytics at any time. See our <a href="/privacy/">Privacy</a> page.
  </div>
  <div class="consent-actions">
    <button id="consent-accept" class="consent-btn primary" type="button">Accept analytics</button>
    <button id="consent-reject" class="consent-btn" type="button">Reject</button>
  </div>
  <span class="sr-only" aria-hidden="true"></span>
  <script>
    (function(){
  var MID = "{{ site.analytics.google.tracking_id | default: '' }}";
      var dnt = (navigator.doNotTrack === '1' || window.doNotTrack === '1' || navigator.msDoNotTrack === '1');
      var $banner = document.getElementById('consent-banner');
      var $accept = document.getElementById('consent-accept');
      var $reject = document.getElementById('consent-reject');

      window.privacyConsent = window.privacyConsent || {};
      function setPref(v){ try{ localStorage.setItem('consent.analytics', v); }catch(e){} }
      function getPref(){ try{ return localStorage.getItem('consent.analytics'); }catch(e){ return null; } }
      function hide(){ if($banner) $banner.classList.add('consent-hidden'); }
      function show(){ if($banner) $banner.classList.remove('consent-hidden'); }
      function hasGtag(){ return typeof window.gtag === 'function'; }
      function updateConsent(val){ if(!hasGtag()) return; window.gtag('consent','update',{ analytics_storage: val }); }

      // Public API to reset preference (used on Privacy page)
      window.privacyConsent.reset = function(){ setPref(''); show(); if(hasGtag()) updateConsent('denied'); };

      // Respect Do Not Track: hide banner and deny analytics
      if(dnt){ hide(); if(MID){ window['ga-disable-' + MID] = true; } if(hasGtag()) updateConsent('denied'); return; }

      // Apply stored preference if present
      var pref = getPref();
      if(pref === 'granted'){ if(hasGtag()) updateConsent('granted'); hide(); }
      else if(pref === 'denied'){ if(hasGtag()) updateConsent('denied'); hide(); }
      else { show(); }

      // Wire buttons
      if($accept) $accept.addEventListener('click', function(){ setPref('granted'); if(hasGtag()) updateConsent('granted'); hide(); });
      if($reject) $reject.addEventListener('click', function(){ setPref('denied'); if(hasGtag()) updateConsent('denied'); hide(); });
    })();
  </script>
</div>

<script>
  (function(){
    try {
      var imgs = document.querySelectorAll('img:not([loading])');
      imgs.forEach(function(img){
        // Skip icons/logos in the masthead to avoid any chance of FOUC
        if (img.closest && img.closest('.masthead')) return;
        img.setAttribute('loading','lazy');
        if(!img.hasAttribute('decoding')) img.setAttribute('decoding','async');
      });
    } catch(e) { /* no-op */ }
  })();
    <div style="text-align:center; margin-top:1rem; font-size:.9rem">
      <a href="#" onclick="if(window.privacyConsent&&privacyConsent.reset){privacyConsent.reset();} return false;">Manage privacy</a>
      <span aria-hidden="true">·</span>
      <a href="/privacy/">Privacy</a>
      <noscript>
        <span aria-hidden="true">·</span>
        <a href="/privacy/">Change my choice</a>
      </noscript>
  
    </div>

</script>
